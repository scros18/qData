# Apache Configuration for qData
# Save this to: /etc/apache2/sites-available/samcroston.com.conf
# Or add these proxy rules to your existing VirtualHost configuration

<VirtualHost *:80>
    ServerName samcroston.com
    ServerAlias www.samcroston.com
    DocumentRoot /var/www/sam-portfolio/build
    
    <Directory /var/www/sam-portfolio/build>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>
    
    # Proxy /qdata to Next.js app running on port 3000
    ProxyPreserveHost On
    ProxyPass /qdata http://localhost:3000/qdata
    ProxyPassReverse /qdata http://localhost:3000/qdata
    
    # Handle WebSocket connections for Next.js hot reload (dev only)
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /qdata/(.*) ws://localhost:3000/qdata/$1 [P,L]
    
    # Redirect HTTP to HTTPS
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
    
    ErrorLog ${APACHE_LOG_DIR}/samcroston.com-error.log
    CustomLog ${APACHE_LOG_DIR}/samcroston.com-access.log combined

    RewriteCond %{SERVER_NAME} =samcroston.com [OR]
    RewriteCond %{SERVER_NAME} =www.samcroston.com
    RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]
</VirtualHost>

<VirtualHost *:443>
    ServerName samcroston.com
    ServerAlias www.samcroston.com
    DocumentRoot /var/www/sam-portfolio/build
    
    <Directory /var/www/sam-portfolio/build>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>
    
    # Proxy /qdata to Next.js app running on port 3000
    ProxyPreserveHost On
    ProxyPass /qdata http://localhost:3000/qdata
    ProxyPassReverse /qdata http://localhost:3000/qdata
    
    # Handle WebSocket connections
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /qdata/(.*) ws://localhost:3000/qdata/$1 [P,L]
    
    # SSL Configuration (Certbot will add these)
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/samcroston.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/samcroston.com/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf
    
    ErrorLog ${APACHE_LOG_DIR}/samcroston.com-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/samcroston.com-ssl-access.log combined
</VirtualHost>
